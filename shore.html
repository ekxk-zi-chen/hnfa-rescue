<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ”¯æ’ç›¸é—œ</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body,
    html {
      font-size: 18px;
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: Arial, sans-serif;
    }

    .container {
      display: flex;
      height: 100%;
    }

    .sidebar {
      width: 240px;
      background-color: #2c3e50;
      color: white;
      padding: 60px 20px 20px;
      overflow-y: auto;
      transition: transform 0.3s ease;
      position: relative;
      /* è®“è¿”å›éµç›¸å°å´é‚Šæ¬„å®šä½ */
    }

    .sidebar h2 {
      font-size: 20px;
      margin-bottom: 16px;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
    }

    .sidebar ul li {
      margin: 12px 0;
      cursor: pointer;
      color: #ecf0f1;
      font-size: 20px;
      /* æˆ–ä½ æƒ³è¦çš„å­—ä½“å¤§å° */
    }

    .sidebar ul li:hover {
      color: #1abc9c;
    }

    .main-content {
      flex-grow: 1;
      padding: 20px;
      padding-top: 60px;
      /* âœ… å¤§è¢å¹•ç‰ˆ */
      overflow-y: auto;
    }

    .menu-button {
      display: none;
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: #2c3e50;
      color: white;
      border: none;
      padding: 10px 14px;
      font-size: 16px;
      cursor: pointer;
      z-index: 1000;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      margin-bottom: 4px;
      color: #333;
    }

    .form-group input {
      width: 100%;
      padding: 8px;
      font-size: 16px;
    }

    /*ä»¥ä¸‹æ”¾è£å‚™æ¸…å–®css*/
    .group-container {
      margin-bottom: 20px;
      border-left: 6px solid #3498db;
      padding: 10px 15px;
      border-radius: 8px;
      background: #f4f4f4;
    }

    .item-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 5px;
      border: 1px solid #ddd;
    }

    .item-details {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: #fff;
      border-radius: 6px;
      border: 1px solid #ddd;
    }

    .item-detail-content {
      display: flex;
      flex-direction: row;
      gap: 10px;
    }

    .item-text {
      flex: 1;
    }

    .item-img {
      flex: 0 0 120px;
    }

    .item-img img {
      max-width: 100%;
      border-radius: 4px;
    }

    /*è£å‚™æ¸…å–®æ–°å¢åˆ°é€™è£¡*/
    @media (max-width: 768px) {
      .main-content {
        padding-top: 30px;
        /* æ‰‹æ©Ÿé›¢é ‚éƒ¨æœ‰é»è·é›¢ */
      }

      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100%;
        z-index: 999;
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .menu-button {
        display: block;
      }

      .container {
        flex-direction: column;
      }

      /*ä»¥ä¸‹æ˜¯è£å‚™æ¸…å–®*/
      .item-detail-content {
        flex-direction: column;
      }

      .item-img {
        flex: unset;
      }

      /*è£å‚™æ¸…å–®çµæŸ*/
    }

    select,
    input {
      margin: 2px 0;
      padding: 2px 4px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #fff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
    }

    select:focus,
    input:focus {
      border-color: #4a90e2;
      box-shadow: 0 0 5px rgba(74, 144, 226, 0.5);
    }

    button {
      margin: 10px 0;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #4CAF50;
      /* ç¶ è‰² */
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    button:hover {
      background-color: #45a049;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    button:active {
      background-color: #3e8e41;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    button:disabled {
      opacity: 0.6;
      /* é€æ˜åº¦é™ä½ï¼Œçœ‹èµ·ä¾†ç°æ‰ */
      cursor: not-allowed;
      /* æ»‘é¼ æ¸¸æ¨™è®Šæˆç¦æ­¢ç¬¦è™Ÿ */
      background-color: #ccc;
      /* èƒŒæ™¯é¡è‰²æ”¹æ·¡ç° */
      color: #666;
      /* å­—é«”é¡è‰²æ”¹æ·¡ç° */
      pointer-events: none;
      /* ç¦æ­¢ä»»ä½•æ»‘é¼ äº‹ä»¶ */
    }

    .result {
      margin-top: 20px;
      padding: 15px;
      background-color: #ecf0f1;
      border-left: 4px solid #1abc9c;
    }

    .result-section {
      margin-bottom: 16px;
    }

    .result-section h3 {
      border-bottom: 2px solid #1abc9c;
      padding-bottom: 4px;
      margin-bottom: 10px;
      color: #16a085;
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px dashed #ccc;
    }

    .result-label {
      flex: 1;
      color: #333;
    }

    .result-value {
      flex: 0 0 auto;
      font-weight: bold;
      color: #e67e22;
    }

    /*ä»¥ä¸‹æ”¾è£å‚™æ¸…å–®æ–°å¢æ‰‹æ©Ÿä»‹é¢*/
    .toggle-btn {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    /*èªªæ˜æ›¸é€£çµ*/
    .link-button {
      display: inline-block;
      padding: 4px 8px;
      background-color: #3498db;
      color: white;
      border-radius: 6px;
      text-decoration: none;
      font-size: 14px;
      margin-left: 6px;
    }

    /* èƒŒæ™¯åˆæˆé¡µé¢çš„å“åº”å¼æ ·å¼ */
    @media (max-width: 768px) {
      #compositeViewer {
        height: 60vh !important;
      }

      input[type="file"],
      select,
      button {
        font-size: 16px !important;
        /* é˜²æ­¢iOSç¼©æ”¾ */
        padding: 12px !important;
      }

      input[type="range"] {
        width: 150px !important;
      }
    }

    /* æ§åˆ¶æŒ‰é’®æ ·å¼ */
    .composite-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }

    .composite-controls button {
      flex: 1;
      min-width: 120px;
    }

    /* æ·»åŠ åˆ°ç°æœ‰çš„ CSS ä¸­ */
    .back-button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      position: absolute;
      /* æ”¹ç‚ºçµ•å°å®šä½ */
      bottom: 20px;
      /* è·é›¢åº•éƒ¨ 20px */
      left: 20px;
      /* è·é›¢å·¦å´ 20px */
      right: 20px;
      /* è·é›¢å³å´ 20px */
      width: auto;
      /* è‡ªå‹•å¯¬åº¦ */
    }

    .back-button:hover {
      background-color: #2980b9;
    }
  </style>

</head>

<body>

  <button class="menu-button" onclick="toggleSidebar()">é¸å–®</button>

  <div class="container">
    <div class="sidebar" id="sidebar">
      <h2>æ•¸å­¸ä¸å¥½</h2>
      <ul>
        <li onclick="showCalculationForm()">è¨ˆç®—</li>

        <li onclick="showBackgroundComposite()">èƒŒæ™¯åˆæˆ</li> <!-- æ–°å¢è¿™è¡Œ -->
        <br>
        <!-- æ·»åŠ è¿”å›æŒ‰é’® -->
        <li class="back-button" onclick="goBackToNavigation()">â† è¿”å›é¸æ“‡é é¢</button>

      </ul>
    </div>
    <div class="main-content" id="main-content">

      <h2>å¥—ä¸€å¥èŠ±æœæœäºŒçš„åè¨€:<br>
        <span style="color: red;">æˆä¹Ÿæ”¯æ’æ•—ä¹Ÿæ”¯æ’</span>
        <p><strong>èªªæ˜ï¼š</strong></p>
        <ul style="padding-left: 30px; line-height: 1.6;">
          <li>æ”¯æ’ç¨®é¡åŒ…å«ï¼š<br>ç®±å‹æ”¯æ’ã€ç‰†é¢æ”¯æ’ã€æ–œæ¨“æ¿æ”¯æ’</li>
          <li>å¯æ ¹æ“šç¾å ´æ¸¬é‡è³‡æ–™è‡ªå‹•è¨ˆç®—æ‰€éœ€æ”¯æ’é•·åº¦èˆ‡ææ–™</li>
          <li>è¨ˆç®—çµæœæœƒå€åˆ†ç‚º<br>ã€Œè‡¨æ™‚æ”¯æ’ã€<br>ã€Œå®Œæ•´æ”¯æ’ã€</li>
        </ul>
        <ul style="padding-left: 28px; line-height: 1.6; background-color: #ffe5e5;">
          <li style="color: red; font-weight: bold;">å°æœ‹å‹æ‰è¨ˆè¼ƒå¾—å¾ˆç²¾ç´°</li>
        </ul>

        <p style="color: #666; font-size: 14px;">è«‹é»é¸å·¦å´é¸å–®ä¾†é–‹å§‹é¸æ“‡è¨ˆç®—é¡å‹ã€‚</p>
    </div>
  </div>
  <!-- ...existing code... -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.124.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.124.0/examples/js/controls/OrbitControls.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- ...existing code... -->
  <script src="shore/shore_data.js"></script>
  <script src="shore/shore_data2.js"></script>
  <script>

    // æ·»åŠ åœ¨ script é–‹é ­ï¼Œç¾æœ‰è®Šé‡å¾Œé¢
    let currentCalculationData = null;
    let currentCalculationType = null;
    // å…¨å±€å˜é‡ç”¨äºå­˜å‚¨åˆæˆç›¸å…³çš„çŠ¶æ€
    let compositeScene = null;
    let compositeCamera = null;
    let compositeRenderer = null;
    let currentModel = null;
    let backgroundImageElement = null;




    // è¿”å›å¯¼èˆªé¡µé¢çš„å‡½æ•°
    function goBackToNavigation() {
      window.location.href = 'navigation.html';
    }

    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("open");
    }




    ////////////////////////////////////////////









    // æ·»åŠ å…¨å±€å˜é‡æ¥è·Ÿè¸ªå®é™…æ¸²æŸ“å°ºå¯¸
    let actualRenderSize = { width: 0, height: 0 };
    // åœ¨ script å¼€å¤´æ·»åŠ å…¨å±€å˜é‡æ¥ä¿å­˜ç›¸æœºçŠ¶æ€
    let cameraState = {
      position: new THREE.Vector3(),
      target: new THREE.Vector3(),
      fov: 60
    };

    function initCompositeViewer() {
      const container = document.getElementById('compositeViewer');
      if (!container) return;

      if (compositeRenderer) {
        compositeRenderer.dispose();
      }

      compositeScene = new THREE.Scene();
      compositeScene.background = null;

      const rect = container.getBoundingClientRect();
      const containerWidth = Math.floor(rect.width);
      const containerHeight = Math.floor(rect.height);

      console.log('åˆå§‹åŒ–å°ºå¯¸:', containerWidth, 'x', containerHeight);

      compositeCamera = new THREE.PerspectiveCamera(
        60,
        containerWidth / containerHeight,
        0.01,
        10000
      );

      compositeCamera.position.set(6, 6, 6);

      compositeRenderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true,
        preserveDrawingBuffer: true
      });

      compositeRenderer.setSize(containerWidth, containerHeight);
      compositeRenderer.setClearColor(0x000000, 0);

      container.innerHTML = '';
      container.appendChild(compositeRenderer.domElement);

      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      compositeScene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(10, 20, 15);
      compositeScene.add(directionalLight);

      const controls = new THREE.OrbitControls(compositeCamera, compositeRenderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.1;

      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        compositeRenderer.render(compositeScene, compositeCamera);
      }
      animate();

      // ğŸ”¥ ç°¡åŒ–ç‰ˆ resize - åªæ›´æ–°å°ºå¯¸,ä¸ç¢°ç›¸æ©Ÿä½ç½®!
      let resizeTimeout;
      window.addEventListener('resize', function () {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function () {
          const container = document.getElementById('compositeViewer');
          if (!container || !compositeRenderer || !compositeCamera) return;

          const newRect = container.getBoundingClientRect();
          const newWidth = Math.floor(newRect.width);
          const newHeight = Math.floor(newRect.height);

          console.log('ğŸ”„ å¼·åˆ¶è¦–çª—èª¿æ•´:', newWidth, 'x', newHeight);

          // ğŸ”¥ å¼·åˆ¶æ›´æ–°
          compositeRenderer.setSize(newWidth, newHeight);
          compositeCamera.aspect = newWidth / newHeight;
          compositeCamera.updateProjectionMatrix();

          // ç¢ºä¿é‡æ–°æ¸²æŸ“
          compositeRenderer.render(compositeScene, compositeCamera);
        }, 100); // ç¸®çŸ­å»¶é²æ™‚é–“
      });

      backgroundImageElement = document.getElementById('backgroundImage');
    }
    // æ”¹é€²çš„æ¨¡å‹åŠ è¼‰å‡½æ•¸ï¼Œç¢ºä¿é©ç•¶çš„ç¸®æ”¾
    function loadModelForComposite() {
      if (!compositeScene) return;

      // æ¸…é™¤ç°æœ‰æ¨¡å‹
      if (currentModel) {
        compositeScene.remove(currentModel);
        currentModel = null;
      }

      const modelType = document.getElementById('modelType').value;

      if (!modelType) {
        alert('è¯·å…ˆé€‰æ‹©æ¨¡å‹ç±»å‹ï¼');
        return;
      }

      // å¦‚æœæ²¡æœ‰è®¡ç®—æ•°æ®ï¼Œå°è¯•ä»è¡¨å•è·å–
      if (!currentCalculationData) {
        if (!tryGetCurrentFormData(modelType)) {
          alert('è«‹å…ˆé€²è¡Œæ”¯æ’è¨ˆç®—æˆ–å¡«å¯«è¡¨å–®æ•¸æ“šï¼');
          return;
        }
      }

      // æ ¹æ®ç±»å‹è°ƒç”¨å¯¹åº”çš„åˆ›å»ºå‡½æ•°
      let modelGroup;
      switch (modelType) {
        case 'box':
          modelGroup = createBoxScene(currentCalculationData);
          break;
        case 'wall':
          modelGroup = createWallScene(currentCalculationData);
          break;
        case 'floor':
          modelGroup = createFloorScene(currentCalculationData);
          break;
      }

      if (modelGroup) {
        currentModel = modelGroup;
        compositeScene.add(currentModel);

        // é—œéµï¼šè¨­ç½®é©ç•¶çš„åˆå§‹ç¸®æ”¾
        const box = new THREE.Box3().setFromObject(currentModel);
        const size = box.getSize(new THREE.Vector3());
        const maxSize = Math.max(size.x, size.y, size.z);

        // æ ¹æ“šæ¨¡å‹å¤§å°è‡ªå‹•èª¿æ•´ç¸®æ”¾
        let initialScale = 1.0;
        if (maxSize > 10) {
          initialScale = 8.0 / maxSize;
        } else if (maxSize < 1) {
          initialScale = 1.5 / maxSize;
        }

        currentModel.scale.set(initialScale, initialScale, initialScale);

        // æ›´æ–°ç¸®æ”¾æ»‘å¡Š
        document.getElementById('scaleSlider').value = initialScale;
        document.getElementById('scaleValue').textContent = Math.round(initialScale * 100) + '%';

        // å±…ä¸­æ¨¡å‹
        setTimeout(() => {
          centerModel();
        }, 100);
      }
    }
    function checkRendererState() {
      const container = document.getElementById('compositeViewer');
      const rect = container.getBoundingClientRect();
      console.log('=== æ¸²æŸ“å™¨ç‹€æ…‹æª¢æŸ¥ ===');
      console.log('å®¹å™¨å¯¦éš›å°ºå¯¸:', rect.width, 'x', rect.height);
      console.log('æ¸²æŸ“å™¨ç•«å¸ƒå°ºå¯¸:', compositeRenderer.domElement.width, 'x', compositeRenderer.domElement.height);
      console.log('ç›¸æ©Ÿæ¯”ä¾‹:', compositeCamera.aspect);
      console.log('è¦–çª—å¤§å°:', window.innerWidth, 'x', window.innerHeight);
      console.log('è¨­å‚™åƒç´ æ¯”:', window.devicePixelRatio);
    }
    // æ–°å¢ï¼šå¾è¡¨å–®ç²å–ç•¶å‰æ•¸æ“š
    function tryGetCurrentFormData(type) {
      const lengthInput = document.getElementById('length');
      if (!lengthInput || !lengthInput.value) return false;

      const formData = {
        "æ¸¬é‡é•·åº¦": parseFloat(lengthInput.value)
      };

      // æ ¹æ“šé¡å‹ç²å–å…¶ä»–åƒæ•¸
      const inputs = {
        'box': ['top', 'bottom', 'wedge', 'spacing', 'connector'],
        'wall': ['top', 'bottom', 'wedge', 'spacing', 'connector', 'stopper', 'angle'],
        'floor': ['top', 'bottom', 'spacing', 'connector', 'stopper', 'angle']
      };

      inputs[type].forEach(key => {
        const input = document.getElementById(key);
        if (input && input.value) {
          formData[key === 'top' ? 'é ‚æ¿åšåº¦' :
            key === 'bottom' ? 'åº•æ¿åšåº¦' :
              key === 'wedge' ? 'æ¥”å‹æœ¨åšåº¦' :
                key === 'spacing' ? 'æ”¯æ’æŸ±é–“è·' :
                  key === 'connector' ? 'é€£æ¥æŸ±å¯¬åº¦' :
                    key === 'stopper' ? 'æ­¢æª”å¯¬åº¦' :
                      key === 'angle' ? 'è§’åº¦' : key] = parseFloat(input.value);
        }
      });

      currentCalculationData = formData;
      currentCalculationType = type;
      return true;
    }

    // æ–°å¢ï¼šå¾ç¾æœ‰è¨ˆç®—å‰µå»ºæ¨¡å‹
    function createModelFromCalculation(type) {
      if (!currentCalculationData) return;

      currentModel = new THREE.Group();
      compositeScene.add(currentModel);

      let modelGroup;
      switch (type) {
        case 'box':
          modelGroup = createBoxScene(currentCalculationData);
          break;
        case 'wall':
          modelGroup = createWallScene(currentCalculationData);
          break;
        case 'floor':
          modelGroup = createFloorScene(currentCalculationData);
          break;
        default:
          return;
      }

      // å°‡å‰µå»ºçš„æ¨¡å‹æ·»åŠ åˆ°ç•¶å‰æ¨¡å‹
      currentModel.add(modelGroup);

      // è¨­ç½®åˆé©çš„åˆå§‹ç¸®æ”¾
      currentModel.scale.set(0.8, 0.8, 0.8);
    }
    // ç‚ºåˆæˆå‰µå»ºç®±å‹æ”¯æ’æ¨¡å‹
    function createBoxModelForComposite() {
      if (!currentCalculationData || currentCalculationType !== "box") {
        alert('è«‹å…ˆé€²è¡Œç›¸å½¢æ”¯æ’è¨ˆç®—ï¼');
        return;
      }

      // æ¸…é™¤ç°æœ‰æ¨¡å‹
      if (currentModel) {
        compositeScene.remove(currentModel);
      }

      currentModel = createBoxScene(currentCalculationData);
      compositeScene.add(currentModel);
      centerModel();
    }

    // ç‚ºåˆæˆå‰µå»ºç‰†é¢æ”¯æ’æ¨¡å‹
    function createWallModelForComposite() {
      if (!currentCalculationData || currentCalculationType !== "wall") {
        alert('è«‹å…ˆé€²è¡Œç‰†é¢æ”¯æ’è¨ˆç®—ï¼');
        return;
      }

      // æ¸…é™¤ç°æœ‰æ¨¡å‹
      if (currentModel) {
        compositeScene.remove(currentModel);
      }

      currentModel = createWallScene(currentCalculationData);
      compositeScene.add(currentModel);
      centerModel();
    }
    // ç‚ºåˆæˆå‰µå»ºæ–œæ¨“æ¿æ”¯æ’æ¨¡å‹
    function createFloorModelForComposite() {
      if (!currentCalculationData || currentCalculationType !== "floor") {
        alert('è«‹å…ˆé€²è¡Œæ–œæ¨“æ¿æ”¯æ’è¨ˆç®—ï¼');
        return;
      }

      // æ¸…é™¤ç°æœ‰æ¨¡å‹
      if (currentModel) {
        compositeScene.remove(currentModel);
      }

      currentModel = createFloorScene(currentCalculationData);
      compositeScene.add(currentModel);
      centerModel();
    }
    // ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡
    document.addEventListener('DOMContentLoaded', function () {
      // æ–‡ä»¶ä¸Šä¼ å¤„ç†
      document.addEventListener('change', function (e) {
        if (e.target.id === 'backgroundUpload') {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              backgroundImageElement.src = event.target.result;
              backgroundImageElement.style.display = 'block';
            };
            reader.readAsDataURL(file);
          }
        }
      });
    });

    // æ‹ç…§åŠŸèƒ½ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
    function capturePhoto() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´æ‹ç…§åŠŸèƒ½,è«‹ä½¿ç”¨ã€Œä¸Šå‚³èƒŒæ™¯åœ–ç‰‡ã€ã€‚');
        return;
      }

      // å‰µå»ºæ‹ç…§ç•Œé¢
      const cameraModal = document.createElement('div');
      cameraModal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  `;

      const video = document.createElement('video');
      video.style.cssText = `
    max-width: 90%;
    max-height: 70%;
    background: #000;
  `;
      video.setAttribute('playsinline', ''); // iOS éœ€è¦
      video.setAttribute('autoplay', '');

      const buttonContainer = document.createElement('div');
      buttonContainer.style.cssText = `
    margin-top: 20px;
    display: flex;
    gap: 10px;
  `;

      const captureBtn = document.createElement('button');
      captureBtn.textContent = 'ğŸ“· æ‹ç…§';
      captureBtn.style.cssText = `
    padding: 15px 30px;
    font-size: 18px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  `;

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'âŒ å–æ¶ˆ';
      cancelBtn.style.cssText = `
    padding: 15px 30px;
    font-size: 18px;
    background: #f44336;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  `;

      buttonContainer.appendChild(captureBtn);
      buttonContainer.appendChild(cancelBtn);
      cameraModal.appendChild(video);
      cameraModal.appendChild(buttonContainer);
      document.body.appendChild(cameraModal);

      // å•Ÿå‹•ç›¸æ©Ÿ
      navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment', // ä½¿ç”¨å¾Œç½®é¡é ­
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        }
      })
        .then(function (stream) {
          video.srcObject = stream;
          video.play();

          // æ‹ç…§æŒ‰éˆ•
          captureBtn.onclick = function () {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // è¨­å®šç‚ºèƒŒæ™¯åœ–ç‰‡
            backgroundImageElement.src = canvas.toDataURL('image/jpeg', 0.9);
            backgroundImageElement.style.display = 'block';

            // åœæ­¢ç›¸æ©Ÿä¸¦é—œé–‰
            stream.getTracks().forEach(track => track.stop());
            document.body.removeChild(cameraModal);

            alert('âœ… ç…§ç‰‡å·²è¨­å®šç‚ºèƒŒæ™¯!');
          };

          // å–æ¶ˆæŒ‰éˆ•
          cancelBtn.onclick = function () {
            stream.getTracks().forEach(track => track.stop());
            document.body.removeChild(cameraModal);
          };
        })
        .catch(function (error) {
          console.error('ç„¡æ³•è¨ªå•ç›¸æ©Ÿ:', error);
          document.body.removeChild(cameraModal);
          alert('ç„¡æ³•è¨ªå•ç›¸æ©Ÿ: ' + error.message + '\n\nè«‹ç¢ºèª:\n1. å·²æˆäºˆç›¸æ©Ÿæ¬Šé™\n2. ä½¿ç”¨ HTTPS é€£ç·š\n3. æˆ–ä½¿ç”¨ã€Œä¸Šå‚³èƒŒæ™¯åœ–ç‰‡ã€åŠŸèƒ½');
        });
    }

    // æ¸…é™¤èƒŒæ™¯
    function clearBackground() {
      backgroundImageElement.style.display = 'none';
      document.getElementById('backgroundUpload').value = '';
    }


    // é‡ç½®æ¨¡å‹ä½ç½®
    function resetModelPosition() {
      if (currentModel) {
        currentModel.position.set(0, 0, 0);
        currentModel.rotation.set(0, 0, 0);
        currentModel.scale.set(1, 1, 1);
        document.getElementById('scaleSlider').value = 1;
        document.getElementById('scaleValue').textContent = '100%';
      }
    }

    // ä¿®å¤æ¨¡å‹å±…ä¸­å‡½æ•°
    function centerModel() {
      if (currentModel && compositeCamera) {
        // é‡ç½®ä½ç½®å’Œæ—‹è½¬
        currentModel.position.set(0, 0, 0);
        currentModel.rotation.set(0, 0, 0);

        // è®¡ç®—è¾¹ç•Œæ¡†å¹¶å±…ä¸­
        const box = new THREE.Box3().setFromObject(currentModel);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());

        // å°†æ¨¡å‹ä¸­å¿ƒç§»åŠ¨åˆ°åŸç‚¹
        currentModel.position.sub(center);

        // è°ƒæ•´ç›¸æœºè§†å›¾
        const maxDim = Math.max(size.x, size.y, size.z);
        const fov = compositeCamera.fov * (Math.PI / 180);

        // è®¡ç®—ç¡®ä¿æ¨¡å‹å®Œå…¨å¯è§çš„è·ç¦»
        let cameraZ = Math.abs(maxDim / Math.sin(fov / 2));
        cameraZ = cameraZ * 1.5; // å¢åŠ é¢å¤–è¾¹è·

        if (window.innerWidth <= 768) {
          compositeCamera.position.set(0, 0, cameraZ * 1.2);
        } else {
          compositeCamera.position.set(0, 0, cameraZ);
        }

        compositeCamera.lookAt(0, 0, 0);
        compositeCamera.updateProjectionMatrix();

        // é‡ç½®æ§åˆ¶å™¨ç›®æ ‡
        const controls = compositeRenderer.domElement._controls;
        if (controls) {
          controls.target.set(0, 0, 0);
          controls.update();
        }

        // ä¿å­˜ç›¸æœºçŠ¶æ€
        if (typeof saveCameraState === 'function') {
          saveCameraState();
        }
      }
    }
    // åˆ·æ–°æ¨¡å‹
    function refreshModel() {
      loadModelForComposite();
    }

    // å…¨æ–°çš„ç²¾ç¡®å¯¼å‡ºå‡½æ•° - å®Œå…¨åŒ¹é…é¢„è§ˆ
    function exportComposite() {
      if (!compositeRenderer) {
        alert('è«‹å…ˆåˆå§‹åŒ–åˆæˆå ´æ™¯!');
        return;
      }

      document.getElementById('compositeResult').innerHTML = '<div style="color: blue; padding: 10px;">â³ æ­£åœ¨ç”Ÿæˆåœ–ç‰‡...</div>';

      const format = document.getElementById('exportFormat').value;
      const mimeType = format === 'jpg' ? 'image/jpeg' : 'image/png';

      // ä½¿ç”¨èˆ‡é è¦½å®Œå…¨ç›¸åŒçš„å°ºå¯¸è¨ˆç®—
      const container = document.getElementById('compositeViewer');
      const rect = container.getBoundingClientRect();
      const targetWidth = Math.floor(rect.width);
      const targetHeight = Math.floor(rect.height);

      console.log('åŒ¯å‡ºå°ºå¯¸è¨ˆç®—:', {
        å®¹å™¨: `${rect.width} Ã— ${rect.height}`,
        æœ€çµ‚: `${targetWidth} Ã— ${targetHeight}`,
        æ¸²æŸ“å™¨: `${compositeRenderer.domElement.width} Ã— ${compositeRenderer.domElement.height}`
      });

      const canvas = document.createElement('canvas');
      canvas.width = targetWidth;
      canvas.height = targetHeight;
      const ctx = canvas.getContext('2d');

      // ç™½è‰²èƒŒæ™¯
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, targetWidth, targetHeight);

      // ğŸ”¥ é—œéµä¿®å¾©ï¼šèƒŒæ™¯åœ–ç‰‡ä½¿ç”¨èˆ‡é è¦½å®Œå…¨ç›¸åŒçš„ object-fit: contain é‚è¼¯
      if (backgroundImageElement && backgroundImageElement.style.display !== 'none' && backgroundImageElement.naturalWidth > 0) {
        const img = backgroundImageElement;
        const containerRatio = targetWidth / targetHeight;
        const imgRatio = img.naturalWidth / img.naturalHeight;

        let drawWidth, drawHeight, offsetX, offsetY;

        // å®Œå…¨è¤‡è£½ object-fit: contain çš„è¨ˆç®—é‚è¼¯
        if (imgRatio > containerRatio) {
          // åœ–ç‰‡è¼ƒå¯¬ï¼Œä»¥å¯¬åº¦ç‚ºåŸºæº–
          drawWidth = targetWidth;
          drawHeight = targetWidth / imgRatio;
          offsetX = 0;
          offsetY = (targetHeight - drawHeight) / 2;
        } else {
          // åœ–ç‰‡è¼ƒé«˜ï¼Œä»¥é«˜åº¦ç‚ºåŸºæº–
          drawHeight = targetHeight;
          drawWidth = targetHeight * imgRatio;
          offsetX = (targetWidth - drawWidth) / 2;
          offsetY = 0;
        }

        console.log('èƒŒæ™¯åœ–ç¹ªè£½åƒæ•¸:', {
          åŸå§‹å°ºå¯¸: `${img.naturalWidth} Ã— ${img.naturalHeight}`,
          ç¹ªè£½å°ºå¯¸: `${drawWidth} Ã— ${drawHeight}`,
          åç§»: `(${offsetX}, ${offsetY})`,
          æ¯”ä¾‹: `å®¹å™¨: ${containerRatio}, åœ–ç‰‡: ${imgRatio}`
        });

        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
      }

      // ğŸ”¥ 3D å…§å®¹ - ç¢ºä¿èˆ‡èƒŒæ™¯åœ–ç›¸åŒçš„å°ºå¯¸å’Œä½ç½®
      if (compositeRenderer && compositeRenderer.domElement) {
        // ç›´æ¥ç¹ªè£½æ¸²æŸ“å™¨å…§å®¹ï¼Œä½¿ç”¨ç›¸åŒçš„å°ºå¯¸
        ctx.drawImage(compositeRenderer.domElement, 0, 0, targetWidth, targetHeight);
      }

      const link = document.createElement('a');
      link.download = 'æ”¯æ’åˆæˆåœ–_' + new Date().getTime() + '.' + format;
      link.href = canvas.toDataURL(mimeType, 0.95);
      link.click();

      document.getElementById('compositeResult').innerHTML =
        '<div style="color: green; padding: 10px;">âœ… åŒ¯å‡ºæˆåŠŸ! (' + targetWidth + 'Ã—' + targetHeight + ')</div>';
    }
    function debugCompositeLayout() {
      const container = document.getElementById('compositeViewer');
      const rect = container.getBoundingClientRect();
      const bg = document.getElementById('backgroundImage');

      const containerRatio = rect.width / rect.height;
      const imgRatio = bg.naturalWidth / bg.naturalHeight;

      let drawWidth, drawHeight, offsetX, offsetY;

      if (imgRatio > containerRatio) {
        drawWidth = rect.width;
        drawHeight = rect.width / imgRatio;
        offsetX = 0;
        offsetY = (rect.height - drawHeight) / 2;
      } else {
        drawHeight = rect.height;
        drawWidth = rect.height * imgRatio;
        offsetX = (rect.width - drawWidth) / 2;
        offsetY = 0;
      }

      console.log('=== åˆæˆä½ˆå±€èª¿è©¦ ===');
      console.log('å®¹å™¨:', rect.width.toFixed(1), 'Ã—', rect.height.toFixed(1));
      console.log('èƒŒæ™¯åœ–åŸå§‹:', bg.naturalWidth, 'Ã—', bg.naturalHeight);
      console.log('èƒŒæ™¯åœ–é¡¯ç¤º:', bg.width, 'Ã—', bg.height);
      console.log('æ¯”ä¾‹ - å®¹å™¨:', containerRatio.toFixed(3), 'åœ–ç‰‡:', imgRatio.toFixed(3));
      console.log('è¨ˆç®—ç¹ªè£½:', drawWidth.toFixed(1), 'Ã—', drawHeight.toFixed(1));
      console.log('è¨ˆç®—åç§»:', `(${offsetX.toFixed(1)}, ${offsetY.toFixed(1)})`);
      console.log('æ¸²æŸ“å™¨:', compositeRenderer.domElement.width, 'Ã—', compositeRenderer.domElement.height);
      console.log('=== èª¿è©¦çµæŸ ===');
    }


    // é¡¯ç¤ºèƒŒæ™¯åˆæˆåŠŸèƒ½ç•Œé¢
    function showBackgroundComposite() {
      const container = document.getElementById("main-content");
      container.innerHTML = `
      <h2>èƒŒæ™¯åˆæˆåŠŸèƒ½</h2>
      
      <!-- æ–°å¢ï¼šåŠ è¼‰è¨ˆç®—çµæœ -->
      <div style="margin-bottom: 20px; padding: 15px; background: #e8f4f8; border-radius: 8px;">
        <h3>0. åŠ è¼‰è¨ˆç®—çµæœ</h3>
        <button onclick="loadCalculationResult()" ${!currentCalculationData ? 'disabled' : ''}>
          ğŸ“¥ åŠ è¼‰æœ€è¿‘è¨ˆç®—çš„æ”¯æ’æ¨¡å‹
        </button>
        <span style="margin-left: 10px; color: #666;">
          ${currentCalculationData ? `å·²ä¿å­˜: ${currentCalculationType}æ”¯æ’` : 'è«‹å…ˆé€²è¡Œæ”¯æ’è¨ˆç®—'}
        </span>
      </div>

      
      <!-- èƒŒæ™¯å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
      <div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
        <h3>1. ä¸Šå‚³èƒŒæ™¯åœ–ç‰‡</h3>
        <input type="file" id="backgroundUpload" accept="image/*" style="margin-bottom: 10px;">
        <button onclick="capturePhoto()" style="margin-left: 10px;">ğŸ“· æ‹ç…§</button>
        <button onclick="clearBackground()" style="margin-left: 10px;">âŒ æ¸…é™¤èƒŒæ™¯</button>
      </div>

      <!-- 3Dæ¨¡å‹é€‰æ‹© -->
      <div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
        <h3>2. é¸æ“‡3Dæ¨¡å‹</h3>
        <select id="modelType" onchange="loadModelForComposite()">
          <option value="">è«‹å…ˆè¨ˆç®—æ”¯æ’ä»¥ç”Ÿæˆæ¨¡å‹</option>
          <option value="box">ç®±å‹æ”¯æ’</option>
          <option value="wall">ç‰†é¢æ”¯æ’</option>
          <option value="floor">æ–œæ¨“æ¿æ”¯æ’</option>
        </select>
        <button onclick="refreshModel()" style="margin-left: 10px;">ğŸ”„ åˆ·æ–°æ¨¡å‹</button>
      </div>

      <!-- æ§åˆ¶é¢æ¿ -->
      <div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
        <h3>3. èª¿æ•´æ¨¡å‹</h3>
        <div>
          <label>ç¸®æ”¾: </label>
          <input type="range" id="scaleSlider" min="0.1" max="3" step="0.1" value="1" onchange="updateModelScale(this.value)" style="width: 200px;">
          <span id="scaleValue">100%</span>
        </div>
        <div style="margin-top: 10px;">
          <button onclick="resetModelPosition()">â†º é‡ç½®ä½ç½®</button>
          <button onclick="centerModel()" style="margin-left: 10px;">ğŸ¯ ç½®ä¸­å°é½Š</button>
        </div>
      </div>

      <!-- åˆæˆé¡¯ç¤ºå€åŸŸ -->
      <div style="position: relative; width: 100%; height: 70vh; border: 2px dashed #ccc; background: white; overflow: hidden;">
        <img id="backgroundImage" style="width: 100%; height: 100%; object-fit: contain; display: none;">
        <div id="compositeViewer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
      </div>

      <!-- å°å‡ºæŒ‰éˆ• -->
      <div style="margin-top: 20px; text-align: center;">
        <button onclick="exportComposite()" style="padding: 12px 24px; font-size: 18px;">ğŸ’¾ åŒ¯å‡ºåˆæˆåœ–ç‰‡</button>
        <button onclick="shareComposite()" style="padding: 12px 24px; font-size: 18px; background-color: #06c755; color: white; border: none; border-radius: 8px; margin-left: 10px;">ğŸ“± åˆ†äº«åœ–ç‰‡</button>
        <select id="exportFormat" style="margin-left: 10px; padding: 10px;">
          <option value="png">PNGæ ¼å¼</option>
          <option value="jpg">JPGæ ¼å¼</option>
        </select>
      </div>

      <div id="compositeResult" style="margin-top: 20px;"></div>
      `;

      // åˆå§‹åŒ–åˆæˆæŸ¥çœ‹å™¨
      initCompositeViewer();

      if (window.innerWidth <= 768) {
        document.getElementById("sidebar").classList.remove("open");
      }
    }

    // ä¿®å¤åˆ†äº«åŠŸèƒ½
    function shareComposite() {
      if (!compositeRenderer) {
        alert('è«‹å…ˆåˆå§‹åŒ–åˆæˆå ´æ™¯!');
        return;
      }

      document.getElementById('compositeResult').innerHTML = '<div style="color: blue; padding: 10px;">â³ æ­£åœ¨ç”Ÿæˆåˆ†äº«åœ–ç‰‡...</div>';

      const container = document.getElementById('compositeViewer');
      const rect = container.getBoundingClientRect();
      const targetWidth = Math.floor(rect.width);
      const targetHeight = Math.floor(rect.height);

      const canvas = document.createElement('canvas');
      canvas.width = targetWidth;
      canvas.height = targetHeight;
      const ctx = canvas.getContext('2d');

      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, targetWidth, targetHeight);

      if (backgroundImageElement && backgroundImageElement.style.display !== 'none' && backgroundImageElement.naturalWidth > 0) {
        const img = backgroundImageElement;
        const containerRatio = targetWidth / targetHeight;
        const imgRatio = img.naturalWidth / img.naturalHeight;
        let drawWidth, drawHeight, offsetX, offsetY;

        if (imgRatio > containerRatio) {
          drawWidth = targetWidth;
          drawHeight = targetWidth / imgRatio;
          offsetX = 0;
          offsetY = (targetHeight - drawHeight) / 2;
        } else {
          drawHeight = targetHeight;
          drawWidth = targetHeight * imgRatio;
          offsetX = (targetWidth - drawWidth) / 2;
          offsetY = 0;
        }

        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
      }

      if (compositeRenderer && compositeRenderer.domElement) {
        ctx.drawImage(compositeRenderer.domElement, 0, 0, targetWidth, targetHeight);
      }

      canvas.toBlob(function (blob) {
        if (!blob) {
          alert('ç”Ÿæˆåœ–ç‰‡å¤±æ•—!');
          return;
        }

        const file = new File([blob], 'æ”¯æ’æ¨¡å‹åˆæˆåœ–_' + new Date().getTime() + '.png', { type: 'image/png' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({
            files: [file],
            title: 'æ”¯æ’æ¨¡å‹åˆæˆåœ–'
          }).then(function () {
            document.getElementById('compositeResult').innerHTML = '<div style="color: green; padding: 10px;">âœ… åˆ†äº«æˆåŠŸ!</div>';
          }).catch(function (error) {
            const link = document.createElement('a');
            link.download = file.name;
            link.href = URL.createObjectURL(blob);
            link.click();
            document.getElementById('compositeResult').innerHTML = '<div style="color: orange; padding: 10px;">ğŸ“¥ å·²ä¸‹è¼‰åœ–ç‰‡</div>';
          });
        } else {
          const link = document.createElement('a');
          link.download = file.name;
          link.href = URL.createObjectURL(blob);
          link.click();
          document.getElementById('compositeResult').innerHTML = '<div style="color: orange; padding: 10px;">ğŸ“¥ å·²ä¸‹è¼‰åœ–ç‰‡</div>';
        }
      }, 'image/png');
    }
    // æ”¹è¿›çš„å¤‡ç”¨ä¸‹è½½åŠŸèƒ½
    function fallbackDownload(canvas, type = 'åŒ¯å‡º') {
      const link = document.createElement('a');
      link.download = `æ”¯æ’æ¨¡å‹åˆæˆåœ–_${new Date().getTime()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();

      document.getElementById('compositeResult').innerHTML = `
        <div style="color: orange; padding: 10px; background: #fff8e6; border-radius: 5px;">
            ğŸ“¥ å·²è‡ªå‹•ä¸‹è¼‰åœ–ç‰‡ï¼ˆç€è¦½å™¨ä¸æ”¯æ´ç›´æ¥åˆ†äº«ï¼‰<br>
            ğŸ“ å°ºå¯¸: ${canvas.width}Ã—${canvas.height}
        </div>
    `;
    }
    // æ·»åŠ è°ƒè¯•å‡½æ•°æ¥æ£€æŸ¥å°ºå¯¸
    function debugSizeInfo() {
      const container = document.getElementById('compositeViewer');
      const renderer = compositeRenderer;

      if (container && renderer) {
        const containerRect = container.getBoundingClientRect();
        console.log('=== å°ºå¯¸è°ƒè¯•ä¿¡æ¯ ===');
        console.log('å®¹å™¨ client:', container.clientWidth, 'x', container.clientHeight);
        console.log('å®¹å™¨ bounding:', Math.floor(containerRect.width), 'x', Math.floor(containerRect.height));
        console.log('æ¸²æŸ“å™¨:', renderer.domElement.width, 'x', renderer.domElement.height);
        console.log('å®é™…æ¸²æŸ“å°ºå¯¸:', actualRenderSize.width, 'x', actualRenderSize.height);
        console.log('è®¾å¤‡åƒç´ æ¯”:', window.devicePixelRatio);
        console.log('=== è°ƒè¯•ç»“æŸ ===');
      }
    }

    // åœ¨åˆå§‹åŒ–åè°ƒç”¨è°ƒè¯•
    setTimeout(debugSizeInfo, 1000);
    function lockModelState() {
      if (!currentModel) return;

      // ä¿å­˜ç•¶å‰æ¨¡å‹ç‹€æ…‹
      currentModel.userData.originalState = {
        position: currentModel.position.clone(),
        rotation: currentModel.rotation.clone(),
        scale: currentModel.scale.clone(),
        visible: currentModel.visible
      };
    }

    // æ¢å¾©æ¨¡å‹ç‹€æ…‹
    function restoreModelState() {
      if (!currentModel || !currentModel.userData.originalState) return;

      const state = currentModel.userData.originalState;
      currentModel.position.copy(state.position);
      currentModel.rotation.copy(state.rotation);
      currentModel.scale.copy(state.scale);
      currentModel.visible = state.visible;
    }
    // æ·»åŠ é‚Šç•Œæª¢æŸ¥å‡½æ•¸ï¼Œç¢ºä¿æ¨¡å‹ä¸æœƒè¢«æ„å¤–å‰ªè£
    function checkModelBounds() {
      if (!currentModel || !compositeCamera) return;

      const box = new THREE.Box3().setFromObject(currentModel);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());

      // æª¢æŸ¥æ¨¡å‹æ˜¯å¦åœ¨ç›¸æ©Ÿè¦–éŒé«”å…§
      const frustum = new THREE.Frustum();
      frustum.setFromProjectionMatrix(
        new THREE.Matrix4().multiplyMatrices(
          compositeCamera.projectionMatrix,
          compositeCamera.matrixWorldInverse
        )
      );

      const modelInFrustum = frustum.intersectsBox(box);

      if (!modelInFrustum) {
        console.warn('æ¨¡å‹éƒ¨åˆ†æˆ–å…¨éƒ¨åœ¨è¦–åœ–å¤–ï¼Œå»ºè­°é‡æ–°å±…ä¸­');
        return false;
      }

      return true;
    }

    // å®šæœŸæª¢æŸ¥æ¨¡å‹é‚Šç•Œï¼ˆå¯é¸ï¼‰
    setInterval(() => {
      if (currentModel) {
        checkModelBounds();
      }
    }, 2000);

    // å°ˆé–€é‡å°æ‰‹æ©Ÿå„ªåŒ–çš„åŒ¯å‡ºåŠŸèƒ½
    function exportComposite() {
      if (!compositeRenderer || !compositeCamera) {
        alert('è«‹å…ˆåˆå§‹åŒ–åˆæˆå ´æ™¯!');
        return;
      }

      document.getElementById('compositeResult').innerHTML = '<div style="color: blue; padding: 10px;">â³ æ­£åœ¨ç”Ÿæˆåœ–ç‰‡...</div>';

      // ğŸ”¥ğŸ”¥ğŸ”¥ é—œéµä¿®å¾©ï¼šå¼·åˆ¶é‡æ–°åŒæ­¥æ¸²æŸ“å™¨å°ºå¯¸ï¼
      const container = document.getElementById('compositeViewer');
      const currentRect = container.getBoundingClientRect();
      const currentWidth = Math.floor(currentRect.width);
      const currentHeight = Math.floor(currentRect.height);

      console.log('ğŸ”¥ ç•¶å‰å¯¦éš›å®¹å™¨å°ºå¯¸:', currentWidth, 'x', currentHeight);
      console.log('ğŸ”¥ æ¸²æŸ“å™¨ç•¶å‰å°ºå¯¸:', compositeRenderer.domElement.width, 'x', compositeRenderer.domElement.height);

      // ğŸ”¥ å¼·åˆ¶æ›´æ–°æ¸²æŸ“å™¨å’Œç›¸æ©Ÿåˆ°ç•¶å‰å¯¦éš›å°ºå¯¸
      compositeRenderer.setSize(currentWidth, currentHeight);
      compositeCamera.aspect = currentWidth / currentHeight;
      compositeCamera.updateProjectionMatrix();

      // ğŸ”¥ å¼·åˆ¶é‡æ–°æ¸²æŸ“ä¸€æ¬¡ï¼Œç¢ºä¿å…§å®¹æ­£ç¢º
      compositeRenderer.render(compositeScene, compositeCamera);

      const format = document.getElementById('exportFormat').value;
      const mimeType = format === 'jpg' ? 'image/jpeg' : 'image/png';

      const canvas = document.createElement('canvas');
      canvas.width = currentWidth;
      canvas.height = currentHeight;
      const ctx = canvas.getContext('2d');

      // ç™½è‰²èƒŒæ™¯
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, currentWidth, currentHeight);

      // èƒŒæ™¯åœ–ç‰‡ - ä½¿ç”¨èˆ‡é è¦½ç›¸åŒçš„ object-fit: contain é‚è¼¯
      if (backgroundImageElement && backgroundImageElement.style.display !== 'none' && backgroundImageElement.naturalWidth > 0) {
        const img = backgroundImageElement;
        const containerRatio = currentWidth / currentHeight;
        const imgRatio = img.naturalWidth / img.naturalHeight;

        let drawWidth, drawHeight, offsetX, offsetY;

        if (imgRatio > containerRatio) {
          drawWidth = currentWidth;
          drawHeight = currentWidth / imgRatio;
          offsetX = 0;
          offsetY = (currentHeight - drawHeight) / 2;
        } else {
          drawHeight = currentHeight;
          drawWidth = currentHeight * imgRatio;
          offsetX = (currentWidth - drawWidth) / 2;
          offsetY = 0;
        }

        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
      }

      // ğŸ”¥ ç¾åœ¨ç¹ªè£½åŒæ­¥å¾Œçš„æ¸²æŸ“å™¨å…§å®¹
      ctx.drawImage(compositeRenderer.domElement, 0, 0, currentWidth, currentHeight);

      const link = document.createElement('a');
      link.download = 'æ”¯æ’åˆæˆåœ–_' + new Date().getTime() + '.' + format;
      link.href = canvas.toDataURL(mimeType, 0.95);
      link.click();

      document.getElementById('compositeResult').innerHTML =
        '<div style="color: green; padding: 10px;">âœ… åŒ¯å‡ºæˆåŠŸ! (' + currentWidth + 'Ã—' + currentHeight + ')</div>';

      console.log('ğŸ”¥ æœ€çµ‚åŒ¯å‡ºå°ºå¯¸:', currentWidth, 'x', currentHeight);
    }
    // æˆåŠŸè¨Šæ¯é¡¯ç¤º
    function showSuccessMessage(width, height, type) {
      const sizeMB = (width * height * 4 / 1024 / 1024).toFixed(2);
      document.getElementById('compositeResult').innerHTML = `
    <div style="color: green; padding: 10px; background: #f0fff0; border-radius: 5px;">
      âœ… ${type}æˆåŠŸï¼<br>
      ğŸ“ å°ºå¯¸: ${width} Ã— ${height} åƒç´ <br>
      ğŸ’¾ ä¼°è¨ˆå¤§å°: ~${sizeMB}MB<br>
      ğŸ“± ${window.innerWidth <= 768 ? 'æ‰‹æ©Ÿå„ªåŒ–' : 'æ¡Œé¢æ¨¡å¼'}<br>
      ğŸ¯ èˆ‡é è¦½å®Œå…¨ä¸€è‡´
    </div>
  `;
    }

    // ä¸‹è¼‰åœ–ç‰‡
    function downloadImage(canvas, type) {
      const link = document.createElement('a');
      link.download = `æ”¯æ’åˆæˆåœ–_${new Date().getTime()}.png`;
      link.href = canvas.toDataURL('image/png', 0.95);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showSuccessMessage(canvas.width, canvas.height, type);
    }


    // æ›´æ–°æ¨¡å‹ç¸®æ”¾ - æ‰‹æ©Ÿå„ªåŒ–
    function updateModelScale(scale) {
      if (currentModel) {
        currentModel.scale.set(scale, scale, scale);
        const percent = Math.round(scale * 100);
        document.getElementById('scaleValue').textContent = `${percent}%`;

        // æ‰‹æ©Ÿä¸Šæä¾›è§¸è¦ºåé¥‹
        if (window.innerWidth <= 768 && 'vibrate' in navigator) {
          navigator.vibrate(10);
        }
      }
    }


    // åŠ è¼‰æœ€è¿‘çš„è¨ˆç®—çµæœ
    function loadCalculationResult() {
      if (!currentCalculationData) {
        alert('è«‹å…ˆé€²è¡Œæ”¯æ’è¨ˆç®—ï¼');
        return;
      }

      // è¨­ç½®æ¨¡å‹é¡å‹
      document.getElementById('modelType').value = currentCalculationType;

      // é¡¯ç¤ºåŠ è¼‰ä¿¡æ¯
      document.getElementById('compositeResult').innerHTML = `
    <div style="color: blue; padding: 10px; background: #f0f8ff; border-radius: 5px;">
      ğŸ“¥ æ­£åœ¨åŠ è¼‰ ${currentCalculationType} æ”¯æ’æ¨¡å‹...
    </div>
  `;

      // çŸ­æš«å»¶é²å¾ŒåŠ è¼‰æ¨¡å‹ï¼Œç¢ºä¿UIæ›´æ–°
      setTimeout(() => {
        loadModelForComposite();

        // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
        document.getElementById('compositeResult').innerHTML = `
      <div style="color: green; padding: 10px; background: #f0fff0; border-radius: 5px;">
        âœ… æˆåŠŸåŠ è¼‰ ${currentCalculationType} æ”¯æ’æ¨¡å‹ï¼
      </div>
    `;
      }, 100);
    }

  </script>

</body>

</html>
