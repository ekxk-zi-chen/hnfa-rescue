<!DOCTYPE html>
<html>
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>花蓮特搜網頁</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js" onload="console.log('LIFF SDK 加载成功')" onerror="console.error('LIFF SDK 加载失败')"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;}
        .form-container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);}
        .form-group { margin-bottom: 20px;}
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333;}
        input, textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box;}
        .submit-btn, .login-btn, .refresh-btn { padding: 15px 30px; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; width: 100%; margin-top: 10px; }
        .submit-btn { background-color: #00C300; color:white;}
        .refresh-btn { background-color: #0084ff; color:white;}
        .submit-btn:disabled, .login-btn:disabled { background-color: #ccc; cursor: not-allowed;}
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; background-color: #f0f8ff;}
        .error { background-color: #ffe6e6; color: #d8000c; border: 1px solid #d8000c;}
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
        .user-info { background-color: #e8f5e8; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #00C300; display:none;}
        .debug-info { background-color: #f9f9f9; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 12px; color: #666; display:none;}
        .instructions { background-color: #fff4e6; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #ffa94d;}
    </style>
    <script>
        // 全局错误处理
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('全局错误:', msg, 'at', url, ':', lineNo);
            document.getElementById('status').textContent = '发生错误: ' + msg;
            return false;
        };
    </script>
</head>
<body>
<div class="form-container">
    <h1>花搜點麵線app</h1>
    <div id="instructions" class="instructions">
        <strong>使用說明：</strong>
        <p>在LINE中打開此應用可自動登入，在電腦上使用需先點擊登入按鈕</p>
    </div>
    <div id="status" class="status">載入中...</div>
    <div id="debug-info" class="debug-info"><strong>除錯資訊：</strong><div id="debug-content"></div></div>
    <div id="user-info" class="user-info">
        <strong>初次登入請輸入您的真實姓名：</strong>
        <div>LINE稱號：<span id="display-name"></span></div>
        <div style="display:none;">UserID：<span id="user-id"></span></div>
    </div>
    <div id="login-section" style="display:none;">
        <button type="button" class="login-btn" id="manual-login-btn">登入 LINE</button>
        <button type="button" class="refresh-btn" id="refresh-btn">重新載入頁面</button>
    </div>
    <form id="myForm" style="display:none;">
        <input type="hidden" id="lineUserId" name="lineUserId">
        <div class="form-group">
            <label for="name">真實姓名：</label>
            <input type="text" id="name" name="name" required placeholder="請輸入您的真實姓名">
        </div>
        <div class="form-group">
            <label for="message">補充說明（可選）：</label>
            <textarea id="message" name="message" rows="1"></textarea>
        </div>
        <button type="submit" class="submit-btn" id="submit-btn">送出表單</button>
    </form>
</div>

<script>
const CONFIG = {
    LIFF_ID: "2007782293-RgkE5pPW",
    API_VERIFY: "https://hnfa-rescue-rhlk5hhw9-ekxk-zi-chens-projects.vercel.app/api/verify",
    DEBUG_: true
};

let ID_TOKEN = null;
let SESSION_TOKEN = localStorage.getItem('sessionToken') || null;
let PROFILE = null;

// ---------- 狀態顯示 ----------
function showStatus(msg, type='info'){
    const el = document.getElementById('status');
    el.textContent = msg;
    el.className = 'status';
    if(type==='error') el.className += ' error';
    if(type==='success') el.className += ' success';
}
function addDebugInfo(info){
    if(!CONFIG.DEBUG_) return;
    const debugEl = document.getElementById('debug-content');
    debugEl.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${info}</div>`;
    document.getElementById('debug-info').style.display='block';
}

// ---------- 檢查 token 過期 ----------
function isIdTokenExpired(token){
    if(!token) return true;
    try{
        const payload = JSON.parse(atob(token.split('.')[1]));
        const exp = payload.exp;
        return (Date.now()/1000) > exp;
    } catch(e){
        return true;
    }
}

// ---------- 初始化 App ----------
async function startApp() {
    try {
        console.log('開始初始化應用');
        showStatus('正在初始化應用...');
        
        // 檢查是否在 LINE 環境中
        const isInLINE = liff.isInClient();
        addDebugInfo('是否在LINE環境中: ' + isInLINE);
        
        // 先驗證 sessionToken (無論是否在LINE環境中)
        if (SESSION_TOKEN) {
            addDebugInfo('有本地 sessionToken，嘗試驗證...');
            const result = await verifyTokenAtServer(null, SESSION_TOKEN);
            
            if (result && result.status === 'ok') {
                addDebugInfo('sessionToken 驗證成功');
                renderForm({ 
                    displayName: result.displayName, 
                    userId: result.userId 
                });
                return;
            } else {
                addDebugInfo('sessionToken 無效，刪除');
                localStorage.removeItem('sessionToken');
                SESSION_TOKEN = null;
            }
        }

        // 不在LINE環境中，顯示登入選項
        if (!isInLINE) {
            addDebugInfo('不在 LINE 環境中，顯示登入按鈕');
            showLoginOptions();
            return;
        }

        // 在LINE環境中，繼續LIFF流程
        // 檢查 LIFF 登入狀態
        if (!liff.isLoggedIn()) {
            addDebugInfo('用戶未登入，嘗試登入');
            liff.login();
            return;
        }

        // 取得 ID Token
        ID_TOKEN = liff.getIDToken();
        addDebugInfo('取得 idToken 長度：' + (ID_TOKEN ? ID_TOKEN.length : 0));

        // 檢查 token 是否過期
        if (isIdTokenExpired(ID_TOKEN)) {
            addDebugInfo('idToken 過期，重新登入');
            liff.login();
            return;
        }

        showStatus('驗證中，請稍候...');
        await verifyIdTokenFlow(ID_TOKEN);

    } catch(e) {
        console.error('啟動錯誤:', e);
        showStatus('系統錯誤，請稍後重試', 'error');
        addDebugInfo('啟動錯誤: ' + e.message);
        showLoginOptions();
    }
}

// ---------- 呼叫後端 API 驗證 ----------
async function verifyTokenAtServer(idToken = null, sessionToken = null) {
    try {
        const payload = { idToken, sessionToken };
        addDebugInfo('發送驗證請求: ' + JSON.stringify({ 
            hasIdToken: !!idToken, 
            hasSessionToken: !!sessionToken 
        }));
        
        const res = await fetch(CONFIG.API_VERIFY, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!res.ok) {
            throw new Error('伺服器回應錯誤: ' + res.status);
        }
        
        const data = await res.json();
        addDebugInfo('後端回傳: ' + JSON.stringify(data));
        return data;
    } catch(e) {
        addDebugInfo('verifyTokenAtServer 錯誤: ' + e.message);
        return null;
    }
}

// ---------- 驗證 idToken 流程 ----------
async function verifyIdTokenFlow(idToken) {
    const result = await verifyTokenAtServer(idToken);
    
    if (!result) {
        addDebugInfo('後端無回應或網路錯誤');
        showStatus('伺服器無回應，請稍後重試', 'error');
        showLoginOptions();
        return;
    }

    switch (result.status) {
        case 'ok':
            addDebugInfo('idToken 驗證成功');
            localStorage.setItem('sessionToken', result.sessionToken);
            SESSION_TOKEN = result.sessionToken;
            renderForm({ 
                displayName: result.displayName, 
                userId: result.userId 
            });
            break;
            
        case 'needsignup':
            addDebugInfo('使用者需要註冊，跳轉報名頁面');
            window.location.href = `signup.html?userId=${result.userId}`;
            break;
            
        case 'error':
            addDebugInfo('後端錯誤: ' + result.message);
            showStatus('驗證失敗: ' + (result.message || '未知錯誤'), 'error');
            showLoginOptions();
            break;
            
        default:
            addDebugInfo('未知的回應狀態: ' + result.status);
            showStatus('驗證失敗，請重新登入', 'error');
            showLoginOptions();
    }
}

// ---------- 顯示登入按鈕 ----------
function showLoginOptions() {
    showStatus('請登入 LINE 或刷新頁面');
    document.getElementById('login-section').style.display = 'block';
    document.getElementById('manual-login-btn').onclick = () => {
        // 嘗試使用LIFF登入，如果失敗則跳轉到LINE登入頁面
        if (liff.isInClient()) {
            liff.login();
        } else {
            // 外部瀏覽器處理
            showStatus('正在跳轉到LINE登入頁面...');
            liff.login({ redirectUri: window.location.href });
        }
    };
    document.getElementById('refresh-btn').onclick = () => location.reload();
}

// ---------- 表單渲染 ----------
function renderForm(profile) {
    PROFILE = profile;
    document.getElementById('display-name').textContent = profile.displayName || '';
    document.getElementById('user-id').textContent = profile.userId || '';
    document.getElementById('lineUserId').value = profile.userId || '';
    document.getElementById('user-info').style.display = 'block';
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('myForm').style.display = 'block';
    document.getElementById('instructions').style.display = 'none';
    showStatus('');
}

// ---------- 表單提交 ----------
async function submitForm(formData) {
    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.textContent = '送出中...';
    
    try {
        const payload = Object.assign({}, formData, { sessionToken: SESSION_TOKEN });
        const res = await fetch(CONFIG.API_VERIFY, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        if (data.status === 'ok') {
            showStatus('送出成功！', 'success');
            document.getElementById('myForm').reset();
        } else {
            showStatus('送出失敗: ' + (data.message || '未知原因'), 'error');
        }
    } catch(err) {
        showStatus('送出失敗，請稍後再試', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = '送出表單';
    }
}

// ---------- 綁定表單 ----------
document.getElementById('myForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = {
        timestamp: new Date().toLocaleString('zh-TW'),
        displayName: document.getElementById('display-name').textContent,
        lineUserId: document.getElementById('lineUserId').value,
        name: document.getElementById('name').value,
        message: document.getElementById('message').value
    };
    submitForm(formData);
});

// ---------- 啟動 ----------
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM 已加载');
    showStatus('正在初始化 LIFF...');
    
    // 检查 LIFF SDK 是否已加载
    if (typeof liff === 'undefined') {
        console.error('LIFF SDK 未加载');
        showStatus('LIFF 功能加载失败，请刷新页面', 'error');
        document.getElementById('login-section').style.display = 'block';
        document.getElementById('instructions').style.display = 'block';
        return;
    }
    
    // 添加 LIFF 初始化超时
    const initTimeout = setTimeout(() => {
        console.error('LIFF 初始化超时');
        showStatus('初始化超时，请刷新页面', 'error');
        document.getElementById('login-section').style.display = 'block';
        document.getElementById('instructions').style.display = 'block';
    }, 10000); // 10秒超时
    
    try {
        liff.init({ liffId: CONFIG.LIFF_ID })
            .then(() => {
                clearTimeout(initTimeout);
                console.log('LIFF 初始化成功');
                startApp();
            })
            .catch(err => {
                clearTimeout(initTimeout);
                console.error('LIFF 初始化失败:', err);
                showStatus('LIFF 初始化失败: ' + err.message, 'error');
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('instructions').style.display = 'block';
                
                // 即使LIFF初始化失败，也尝试使用现有的sessionToken
                if (SESSION_TOKEN) {
                    addDebugInfo('LIFF初始化失败，但存在sessionToken，尝试验证');
                    verifyTokenAtServer(null, SESSION_TOKEN)
                        .then(result => {
                            if (result && result.status === 'ok') {
                                renderForm({ 
                                    displayName: result.displayName, 
                                    userId: result.userId 
                                });
                            }
                        });
                }
            });
    } catch (e) {
        clearTimeout(initTimeout);
        console.error('LIFF 初始化异常:', e);
        showStatus('初始化异常: ' + e.message, 'error');
        document.getElementById('login-section').style.display = 'block';
        document.getElementById('instructions').style.display = 'block';
    }
});
</script>

</body>
</html>
